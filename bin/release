#!/usr/bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';

use Monolog\Handler\StreamHandler;
use Monolog\Logger;

const COMPOSER_JSON_DEST = __DIR__ . '/../composer.json';
const SYS_TMP_DIR = '/tmp';
const TMP_DIR = SYS_TMP_DIR . '/FinSearch';
const IGNORED = [
    'FinSearch/phpunit.xml.dist',
    'FinSearch/phpcs.xml',
    'FinSearch/tests/\*',
    'FinSearch/archive.sh',
    'FinSearch/composer.lock',
    'FinSearch/.gitignore',
    'FinSearch/.travis.yml',
    'FinSearch/.idea/\*',
    'FinSearch/.git/\*',
    '*.zip',
];

$logger = new Logger('release');
$logger->pushHandler(new StreamHandler('php://stdout'));

$composerJsonData = json_decode(file_get_contents(COMPOSER_JSON_DEST), true);
$version = $composerJsonData['version'];

$logger->info(sprintf('Creating a release for version %s', $version));
$logger->info('The zip can be uploaded directly to the Shopware Store.');

$logger->info('Running "git stash" to preserve local changes.');
$stash = exec('git stash');
exec('git fetch --all --tags --prune');

$tag = exec(sprintf('git tag -l %s', $version));
$workingBranch = exec('git branch | grep \* | cut -d \' \' -f2');

if (!$tag) {
    $logger->error(sprintf('Tag %s not found.', $version));
    exit(1);
}

exec(sprintf('git checkout tags/%s', $tag));

$logger->info('Copying files...');
exec(sprintf('cp -rf . %s', TMP_DIR));

$logger->info('Installing dependencies...');
exec(sprintf('composer install -d=%s --no-dev --optimize-autoloader --prefer-dist', TMP_DIR));

$logger->info('Adding shopware/core and shopware/storefront to the composer.json.');
$composerJsonData['require']['shopware/core'] = '^6.1';
$composerJsonData['require']['shopware/storefront'] = '^6.1';
file_put_contents(TMP_DIR . '/composer.json', json_encode($composerJsonData, JSON_PRETTY_PRINT));

$zipFileDest = sprintf('%s/FinSearch-%s.zip', __DIR__, $version);
exec(sprintf('zip -r9 %s %s -x %s', $zipFileDest, TMP_DIR, implode(' ', IGNORED)));

exec('rm -rf "/tmp/FinSearch"');

$logger->info('Restoring work in progress ...');
exec(sprintf('get checkout %s', $workingBranch));

if ($stash) {
    exec('git stash pop');
}

$logger->info(sprintf('The release was successfully created! You can find it in %s', $zipFileDest));
